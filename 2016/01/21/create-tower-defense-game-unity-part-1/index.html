<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>使用unity创建塔防游戏(译)(part1) | le0zh&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="塔防游戏非常地受欢迎，木有什么能比看着自己的防御毁灭邪恶的入侵者更爽的事了。在这个包含两部分的教程中，你将使用Unity创建一个塔防游戏。
你将会学到如何：

创建一波一波的敌人
使敌人随着路标移动
创建和升级防御塔，并将敌人销毁

最后，你会有一个此类型游戏的框架，之后可在此基础之上进行扩展。">
<meta property="og:type" content="article">
<meta property="og:title" content="使用unity创建塔防游戏(译)(part1)">
<meta property="og:url" content="http://le0zh.github.io/2016/01/21/create-tower-defense-game-unity-part-1/index.html">
<meta property="og:site_name" content="le0zh's blog">
<meta property="og:description" content="塔防游戏非常地受欢迎，木有什么能比看着自己的防御毁灭邪恶的入侵者更爽的事了。在这个包含两部分的教程中，你将使用Unity创建一个塔防游戏。
你将会学到如何：

创建一波一波的敌人
使敌人随着路标移动
创建和升级防御塔，并将敌人销毁

最后，你会有一个此类型游戏的框架，之后可在此基础之上进行扩展。">
<meta property="og:image" content="http://cdn4.raywenderlich.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-26-at-18.29.53.png">
<meta property="og:image" content="http://cdn1.raywenderlich.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-26-at-18.41.11.png">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2015/05/Screen-Shot-2015-05-31-at-09.48.38.png">
<meta property="og:image" content="http://7xl2vf.com1.z0.glb.clouddn.com/game-view.png">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/first_open_spot.png">
<meta property="og:image" content="http://cdn3.raywenderlich.com/wp-content/uploads/2015/07/prefab.gif">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2015/05/Screen-Shot-2015-05-31-at-09.49.54.png">
<meta property="og:image" content="http://cdn1.raywenderlich.com/wp-content/uploads/2015/06/Bildschirmfoto-2015-06-06-um-14.42.08.png">
<meta property="og:image" content="http://cdn2.raywenderlich.com/wp-content/uploads/2015/07/assign-prefab.gif">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/build-monsters-everywhere.png">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-27-at-17.19.50.png">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/SpecialBike.jpg">
<meta property="og:image" content="http://cdn4.raywenderlich.com/wp-content/uploads/2015/07/Screen-Shot-2015-07-24-at-11.26.28-AM.png">
<meta property="og:image" content="http://cdn1.raywenderlich.com/wp-content/uploads/2015/07/assign-monsters2.gif">
<meta property="og:image" content="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/MonsterData1.png">
<meta property="og:image" content="http://cdn3.raywenderlich.com/wp-content/uploads/2015/06/No-more-mushyness.png">
<meta property="og:image" content="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/Upgrade-monsters.png">
<meta property="og:image" content="http://cdn4.raywenderlich.com/wp-content/uploads/2015/06/sharedData.png">
<meta property="og:image" content="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/Assign-goldLabel.png">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/1000-gold.png">
<meta property="og:image" content="http://cdn3.raywenderlich.com/wp-content/uploads/2015/06/Bildschirmfoto-2015-06-06-um-16.45.32.png">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/Monsters-cost-gold.png">
<meta property="og:image" content="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/Road-waypoint-hierarchy.png">
<meta property="og:image" content="http://cdn1.raywenderlich.com/wp-content/uploads/2015/07/Screen-Shot-2015-07-24-at-12.09.11-PM1.png">
<meta property="og:image" content="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/Bug1-1.png">
<meta property="og:image" content="http://cdn2.raywenderlich.com/wp-content/uploads/2015/07/waypoints2.gif">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2012/07/certaindeath.jpg">
<meta property="og:image" content="http://cdn1.raywenderlich.com/wp-content/uploads/2015/06/BugFollowsRoadWithoutRotating.gif">
<meta property="og:updated_time" content="2016-01-21T04:35:32.013Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用unity创建塔防游戏(译)(part1)">
<meta name="twitter:description" content="塔防游戏非常地受欢迎，木有什么能比看着自己的防御毁灭邪恶的入侵者更爽的事了。在这个包含两部分的教程中，你将使用Unity创建一个塔防游戏。
你将会学到如何：

创建一波一波的敌人
使敌人随着路标移动
创建和升级防御塔，并将敌人销毁

最后，你会有一个此类型游戏的框架，之后可在此基础之上进行扩展。">
  
    <link rel="alternative" href="/atom.xml" title="le0zh&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xl2vf.com1.z0.glb.clouddn.com/imgle0zh.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">le0zh</a></h1>
		</hgroup>

		
		<p class="header-subtitle">梦想 行动 坚持</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>標籤</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/le0zh" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/li9ht" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/ES6/" style="font-size: 10px;">ES6</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/jstips/" style="font-size: 16.67px;">jstips</a> <a href="/tags/react/" style="font-size: 10px;">react</a> <a href="/tags/react-native/" style="font-size: 13.33px;">react-native</a> <a href="/tags/unity/" style="font-size: 10px;">unity</a>
					</div>
				</section>
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">le0zh</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://7xl2vf.com1.z0.glb.clouddn.com/imgle0zh.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">le0zh</h1>
			</hgroup>
			
			<p class="header-subtitle">梦想 行动 坚持</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/le0zh" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/li9ht" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-create-tower-defense-game-unity-part-1" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/01/21/create-tower-defense-game-unity-part-1/" class="article-date">
  	<time datetime="2016-01-21T04:40:12.000Z" itemprop="datePublished">2016-01-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      使用unity创建塔防游戏(译)(part1)
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unity/">unity</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/game/">game</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>塔防游戏非常地受欢迎，木有什么能比看着自己的防御毁灭邪恶的入侵者更爽的事了。<br>在这个包含两部分的教程中，你将使用Unity创建一个塔防游戏。</p>
<p>你将会学到如何：</p>
<ul>
<li>创建一波一波的敌人</li>
<li>使敌人随着路标移动</li>
<li>创建和升级防御塔，并将敌人销毁</li>
</ul>
<p>最后，你会有一个此类型游戏的框架，之后可在此基础之上进行扩展。<br><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-26-at-18.29.53.png" alt="img"></p>
<a id="more"></a> 
<h3 id="u6700_u7EC8_u6548_u679C"><a href="#u6700_u7EC8_u6548_u679C" class="headerlink" title="最终效果"></a>最终效果</h3><p>在本篇教程中，你将创建一个塔防游戏，敌人（小虫子）会朝着你的饼干移动，你可以在一些战略点上，使用金币放置和升级你收下的小怪兽来进行防御。</p>
<p>玩家必须在小虫子抵达饼干之前消灭它们，敌人会随着波数的增加而变得更加强大。 游戏将在玩家在所有波数之后存活下来（游戏胜利），或者有5个敌人抵达饼干之后结束（游戏失败）。</p>
<p>下面是一张完成的游戏截图:</p>
<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-26-at-18.41.11.png" alt="img"></p>
<h3 id="u51C6_u5907_u5F00_u59CB"><a href="#u51C6_u5907_u5F00_u59CB" class="headerlink" title="准备开始"></a>准备开始</h3><p>如果你还没有Unity5，请从<a href="http://unity3d.com/get-unity/" target="_blank" rel="external">Unity的官网</a>下载。</p>
<p>同时，下载这个<a href="http://7xl2vf.com1.z0.glb.clouddn.com/td/TowerDefense-Part1-Starter.zip" target="_blank" rel="external">starter项目</a>，解压缩并且使用unity打开<code>TowerDefense-Part1-Starter</code>这个工程。<br>starter项目中包括了美术和声音资源，同时还有预设的动画以及一些帮助用的脚本，这些脚本跟塔防游戏没有直接的关系，所以不会再本教程中详细介绍。但是如果你想要更多的学习关于unity 2d动画的创建，请参考<a href="http://www.raywenderlich.com/66345/unity-2d-tutorial-animations" target="_blank" rel="external">Unity 2D 教程</a>。</p>
<p>项目中同时包含了一些 <code>prefab</code>供你稍后扩展用来创建游戏角色。最后，工程中包含背景和UI设置好的场景。</p>
<p>在<code>Scenes</code>文件夹中找到并打开<code>GameScene</code>, 设置Game视图的显示比例为4:3来保证labels能够正确的在背景中对齐，你在Game视图中看到的应该如下所示:</p>
<p><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2015/05/Screen-Shot-2015-05-31-at-09.48.38.png" alt="img"></p>
<blockquote>
<p>注：一开始我也没弄清楚什么意思，后来理解了是在<br><img src="http://7xl2vf.com1.z0.glb.clouddn.com/game-view.png" alt="img"><br>这里所示的窗口</p>
</blockquote>
<p>Starter project – check!<br>Assets – check!<br>走向征服世界的第一步(你的塔防游戏…)已经准备好了!</p>
<h3 id="u53EF_u653E_u7F6E_u70B9_u7684_X__u6807_u8BB0"><a href="#u53EF_u653E_u7F6E_u70B9_u7684_X__u6807_u8BB0" class="headerlink" title="可放置点的 X 标记"></a>可放置点的 X 标记</h3><p>小怪兽只能放在标记有X的地方。<br>从<code>Project Brower</code>中拖动<code>Images\Objects\Openspot</code>到场景中，目前来说放到哪个位置没有关系。</p>
<p>在<code>Hierarchy</code>中选中<code>Openspot</code>，在<code>Inspector</code>面板点击 <code>Add Component</code>并且选择 <code>Physics 2D\Box Collider 2D</code>。 Unity将会在场景中以绿色的线显示盒子碰撞器。你将会使用这个碰撞器来检测在某个点的鼠标点击。<br><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/first_open_spot.png" alt="img"></p>
<p>使用相同的步骤，添加一个<code>Audio\Audio Source</code>组件到 <code>Openspot</code>上。并且设置<code>Audio Source’s AudioClip</code> 为 <code>tower_place</code>（可以在<code>Audio</code>文件夹中找到），记住不能勾选<code>Play On Awake</code>。</p>
<p>你需要再创建11个放置点，每个都得重复上面的步骤，不过不用担心，Unity有一个很好的解决办法: Prefab！</p>
<p>将<code>OpenSpot</code>从<code>Hierarchy</code>拖动到<code>Project Browser</code>里面的<code>Prefabs</code>文件夹，它的名字在<code>Hierarchy</code>将会变成蓝色，用来标示它是和一个prefab相关联的。像下面这样:<br> <img src="http://cdn3.raywenderlich.com/wp-content/uploads/2015/07/prefab.gif" alt="gif"></p>
<p>现在，你拥有了一个prefab，你就可以创建任意多的拷贝。简单的将<code>Openspot</code>从<code>Prefabs</code>文件夹中拖拽到场景中，再重复11次，一共在场景中创建12个放置点。<br>下面使用<code>Inspector</code>面板来分别设置这个12个放置点的坐标如下:</p>
<ul>
<li>(-5.2, 3.5, 0)</li>
<li>(-2.2, 3.5, 0)</li>
<li>(0.8, 3.5, 0)</li>
<li>(3.8, 3.5, 0)</li>
<li>(-3.8, 0.4, 0)</li>
<li>(-0.8, 0.4, 0)</li>
<li>(2.2, 0.4, 0)</li>
<li>(5.2, 0.4, 0)</li>
<li>(-5.2, -3.0, 0)</li>
<li>(-2.2, -3.0, 0)</li>
<li>(0.8, -3.0, 0)</li>
<li>(3.8, -3.0, 0) </li>
</ul>
<p>结束后，你的场景应该像下面这样:<br><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2015/05/Screen-Shot-2015-05-31-at-09.49.54.png" alt="img"></p>
<h3 id="u653E_u7F6E_u5C0F_u602A_u517D_28_u9632_u5FA1_u5854_29"><a href="#u653E_u7F6E_u5C0F_u602A_u517D_28_u9632_u5FA1_u5854_29" class="headerlink" title="放置小怪兽(防御塔)"></a>放置小怪兽(防御塔)</h3><p>为了使放置的工作简单点儿，工程的Prefab文件下中包含了一个<code>Monster</code>的prefab。<br><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2015/06/Bildschirmfoto-2015-06-06-um-14.42.08.png" alt="img"></p>
<p>现在，它包含了一个空的游戏对象，由三种不同的精灵组成，和他们各自的射击动画。</p>
<p>每一个精灵代表了小怪兽不同的能力级别。<code>Monster</code>的prefab同时包含了一个<code>Audio Source</code>的组件，当怪兽发射激光的时候会触发播放声音。</p>
<p>现在你将创建一个脚本来在<code>Openspot</code>上放置一个小怪兽。</p>
<p>在<code>Project Browser</code>中 选择<code>Openspot</code>，在<code>Inspector</code>面板中，点击 <code>Add Component</code>然后选择<code>New Script</code>并重命名为<code>PlaceMonster</code>，选择C#作为脚本语言并以此点击<code>Create</code>和<code>Add</code>。因为你是向prefab添加的脚本，所以场景中所有的<code>Openspot</code>都将会被附件该脚本。</p>
<p>双击刚才创建的脚本，在编辑器中打开。然后添加下面的这两个变量<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> GameObject monsterPrefab;</span><br><span class="line"><span class="keyword">private</span> GameObject monster;</span><br></pre></td></tr></table></figure></p>
<p>你将使用<code>monsterPrefab</code>中的对象实例化一个拷贝来创建一个小怪兽，然后保存在<code>monster</code>变量中，方便之后的操作。</p>
<h3 id="u4E00_u4E2A_u4F4D_u7F6E_u4E00_u4E2A_u602A_u517D"><a href="#u4E00_u4E2A_u4F4D_u7F6E_u4E00_u4E2A_u602A_u517D" class="headerlink" title="一个位置一个怪兽"></a>一个位置一个怪兽</h3><p>添加下面的方法来限制一个位置只能放置一个怪兽:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">canPlaceMonster</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> monster == <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>canPlaceMonster</code>方法中，我们检查<code>monster</code>变量是否为<code>null</code>，如果是的，则表示当前没有放置小怪兽，所以是允许放置一个的。</p>
<p>再添加下面的代码，来执行当玩家点击鼠标之后放置一个怪兽:<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnMouseUp</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">//2</span></span><br><span class="line">    <span class="keyword">if</span> (canPlaceMonster())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//3</span></span><br><span class="line">        monster = (GameObject)Instantiate(monsterPrefab, transform.position, Quaternion.identity);</span><br><span class="line">        <span class="comment">//4</span></span><br><span class="line">        AudioSource audioSource = gameObject.GetComponent&lt;AudioSource&gt;();</span><br><span class="line">        audioSource.PlayOneShot(audioSource.clip);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//<span class="doctag">todo:</span> Deduct gold</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码在玩家点击或者Tap的时候放置一个怪兽，那么如何工作的呢？</p>
<ol>
<li>当玩家点击一个游戏对象的碰撞器的时候，Unity会自动的调用<code>OnMouseUp</code>方法<br>2 . 当被调用之后，这个方法会检查是否可以放置怪兽，如果可则放置一个新的怪兽</li>
<li>使用 <code>Instantiate</code>方法创建一个怪兽对象，这个方法会根据指定的prefab和指定的位置和旋转角度创建一个对象。在本例中，我们拷贝了<code>monsterPrefab</code> ，并指定了当前游戏对象的位置，以及没有旋转，最后将结果转换为<code>GameObject</code>类型存储在<code>monster</code>变量中。</li>
<li>最后，调用<code>PlayOneShot</code>方法播放附加在<code>AudioSource</code>组件上的声音特效。</li>
</ol>
<p>现在我们的<code>PlaceMonster</code>脚本已经可以放置新的怪兽了，但还需要指定prefab这个步骤。</p>
<h3 id="u4F7F_u7528_u6B63_u786E_u7684Prefab"><a href="#u4F7F_u7528_u6B63_u786E_u7684Prefab" class="headerlink" title="使用正确的Prefab"></a>使用正确的Prefab</h3><p>在代码编辑器中保存，并返回Unity 。</p>
<p>下面给<code>monsterPrefab</code>赋值，首先在Prefabs文件夹中选中<code>OpenSpot</code>，在<code>Inspector</code>面板中，点击<code>PlaceMonster (Script)</code>组件的<code>Monster Prefab</code>属性右边的小圆圈按钮，然后在弹出来的对话框中选择<code>Monster</code>。<br><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2015/07/assign-prefab.gif" alt="gif"></p>
<p>现在开始游戏，在 X 标记上点击来创建一些怪物~<br><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/build-monsters-everywhere.png" alt="img"></p>
<h3 id="u5347_u7EA7_u6211_u4EEC_u7684_u602A_u7269"><a href="#u5347_u7EA7_u6211_u4EEC_u7684_u602A_u7269" class="headerlink" title="升级我们的怪物"></a>升级我们的怪物</h3><p>在下面的图片中，我们看到怪物在不同的等级有不同的外观<br><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2015/03/Screen-Shot-2015-03-27-at-17.19.50.png" alt="img"></p>
<p>我们需要一个脚本来作为怪物升级系统实现的基础，来跟踪管理怪物在各个级别的能力大小，当然还有怪物所处的当前等级。</p>
<p>现在来添加这个脚本 。</p>
<p>在<code>Project Browser</code>中选中 <code>Prefabs/Monster</code>，添加一个新的C#脚本命名为<code>MonsterData</code>，在代码编辑器中打开该脚本并添加下面的代码在<code>MonsterData</code> 类的上面:<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[System.Serializable]</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MonsterLevel</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> cost;</span><br><span class="line">    <span class="keyword">public</span> GameObject visualization;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里定义了一个<code>MonsterLevel</code>类型，包含了费用（金币）以及对于某个特定等级的视觉效果。</p>
<p>我们添加了<code>[System.Serializable]</code>这个特性来使这个类的对象可以在<code>inspector</code>面板中编辑。这可以使我们方便快速的改变<code>MonsterLevel</code>中的值，甚至在游戏运行过程中。这在调节游戏平衡性的时候特别的有用。</p>
<h3 id="u5B9A_u4E49_u602A_u7269_u7684_u7B49_u7EA7"><a href="#u5B9A_u4E49_u602A_u7269_u7684_u7B49_u7EA7" class="headerlink" title="定义怪物的等级"></a>定义怪物的等级</h3><p>我们将预先定义的<code>MonsterLevel</code>存储在<code>List&lt;T&gt;</code>中。</p>
<p>为什么不简单的使用数组<code>MonsterLevel []</code>呢，首先我们会经常用到某个特定<code>MonsterLevel</code>对象的下标，当然如果使用数组编写一点代码来做这件事也不是特别困难。我们可以直接使用<code>List</code>对象的<code>IndexOf()</code>方法，没有必要重新发明轮子了这次 :]<br><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/SpecialBike.jpg" alt="img"></p>
<p>在MonsterData.cs文件的顶部，添加下面的引用：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">using</span> <span class="tag">System</span><span class="class">.Collections</span><span class="class">.Generic</span>;</span><br></pre></td></tr></table></figure></p>
<p>这将允许我们使用泛型的数据结构类型，所以可以在脚本代码中使用<code>List&lt;T&gt;</code>。</p>
<p> 接下来添加下面的变量到<code>MonsterData</code>类中，用来存储<code>MonsterLevel</code>的列表:<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">List</span>&lt;MonsterLevel&gt; levels;</span><br></pre></td></tr></table></figure></p>
<p>使用泛型，可以保证<code>levels</code>只能存放<code>MonsterLevel</code>类型的对象 。</p>
<p>在代码编辑器中保存文件，并返回到Unity中配置每个阶段.</p>
<p>在<code>Project Browser</code>中选中<code>Prefabs/Monster</code>，然后在<code>Inspector</code>面板中我们可以在<code>MonsterData (Script)</code>组件看到<code>Levels</code>属性，设置<code>size</code>为3<br><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2015/07/Screen-Shot-2015-07-24-at-11.26.28-AM.png" alt="img"></p>
<p>接下来，设置每个等级的花费如下：</p>
<ul>
<li>Element 0: 200</li>
<li>Element 1: 110</li>
<li>Element 2: 120</li>
</ul>
<p>接下来，给<code>visualization</code>赋值。</p>
<p>在project browers中展开<code>Prefabs/Monster</code>来查看其子节点。拖拽子节点<code>Monster0</code>到<code>visualization</code>属性的<code>Element 0</code>。<br>重复上面的动作<code>Monster1</code>对<code>Element 1</code>，<code>Monster2</code>对<code>Element 2</code>，参考下面动图中的演示：</p>
<p><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2015/07/assign-monsters2.gif" alt="gif"></p>
<p>现在，当你选中了<code>Prefabs/Monster</code>，它应该看下像下面这样子：<br><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/MonsterData1.png" alt="img"></p>
<h3 id="u5B9A_u4E49_u5F53_u524D_u7684_u7B49_u7EA7"><a href="#u5B9A_u4E49_u5F53_u524D_u7684_u7B49_u7EA7" class="headerlink" title="定义当前的等级"></a>定义当前的等级</h3><p> 切换回MonsterData.cs中，向<code>MonsterData</code>类中添加另外一个变量：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MonsterLevel currentLevel;</span><br></pre></td></tr></table></figure></p>
<p>在私有变量<code>currentLevel</code>中，我们存放怪物当前的等级信息。<br>现在设置<code>currentLevel</code>同时将它暴露给其他脚本使用，添加下面的代码到<code>MonsterData</code>中：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="keyword">public</span> MonsterLevel CurrentLevel</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//2</span></span><br><span class="line">    <span class="keyword">get</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> currentLevel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3</span></span><br><span class="line">    <span class="keyword">set</span></span><br><span class="line">    &#123;</span><br><span class="line">        currentLevel = <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> currentLevelIndex = levels.IndexOf(currentLevel);</span><br><span class="line"></span><br><span class="line">        GameObject levelVisualization = levels[currentLevelIndex].visualization;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i&lt; levels.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(levelVisualization != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(i == currentLevelIndex)</span><br><span class="line">                &#123;</span><br><span class="line">                    levels[i].visualization.SetActive(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    levels[i].visualization.SetActive(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>看起来有很多C#代码，我们慢慢来看：</p>
<ol>
<li>为私有变量<code>currentLevel</code>定义一个属性。当属性被定义之后，你就能像其他变量一样去调用，既可以<code>CurrentLevel</code>这样在类的内部调用，也可以使用<code>monster.CurrentLevel</code>这样在类的外部调用。然后还能自定义属性的getter和setter方法，通过只提供一个getter，只有一个setter或者都有，来控制一个属性是只读的、只写的或者读写的。</li>
<li>在getter方法中，直接返回私有变量<code>currentLevel</code>的值</li>
<li>在setter方法中，给<code>currentLevel</code>赋值。先拿到当前等级的下标，然后遍历<code>levels</code>数组依据<code>currentLevelIndex</code>的值设置外观的活动或者非活动状态，好处就在于不管什么时候谁设置了<code>currentLevel</code>，精灵会自动更新。</li>
</ol>
<p>添加下面的<code>OnEnable</code>的一个实现：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnEnable</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    CurrentLevel = levels[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里设置了<code>CurrentLevel</code>的默认值，确保它只显示正确的那个精灵。</p>
<h4 id="u6CE8_u610F"><a href="#u6CE8_u610F" class="headerlink" title="注意"></a>注意</h4><p>在<code>OnEnable</code>中而不是<code>OnStart</code>中初始化属性的值，是因为当prefabs被实例化时方法的调用次序问题。<br><code>OnEnable</code>会在创建prefab时立即被调用，而<code>OnStart</code>会等到对象作为场景的一部反的时候才会被调用。<br>这里我们需要在放置一个怪兽之前就要初始化一下，所以在<code>OnEnable</code>中初始化。</p>
<blockquote>
<p>注意OnEnable中的大小写，如果大小写不对，方法不会被调用！</p>
</blockquote>
<p>保存文件返回到Unity中，运行项目并且放置一些怪兽，现在他们显示正确的，也就是最低等级的精灵，如下图：<br><img src="http://cdn3.raywenderlich.com/wp-content/uploads/2015/06/No-more-mushyness.png" alt="img"></p>
<h3 id="u5347_u7EA7_u5C0F_u602A_u517D"><a href="#u5347_u7EA7_u5C0F_u602A_u517D" class="headerlink" title="升级小怪兽"></a>升级小怪兽</h3><p>返回到代码编辑器，增加下面的方法到<code>MonsterData</code>中：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MonsterLevel <span class="title">getNextLevel</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> currentLevelIndex = levels.IndexOf(currentLevel);</span><br><span class="line">    <span class="keyword">int</span> maxLevelIndex = levels.Count - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (currentLevelIndex &lt; maxLevelIndex)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> levels[currentLevelIndex+<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> null;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在<code>getNextLevel</code>方法中，我们首先拿到当前等级的下标以及最高等级的下标，以此判断如果当前不是最高等级时，返回下个等级，否则返回null。</p>
<p>我们可以使用该方法判断是否可以升级到下一个等级。</p>
<p>添加下面的方法增加怪兽的等级：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increaseLevel</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> currentLevelIndex = levels.IndexOf(currentLevel);</span><br><span class="line">    <span class="keyword">if</span> (currentLevelIndex &lt; levels.Count - <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        CurrentLevel = levels[currentLevelIndex+<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们获取当前等级的下标，然后确保它不会大于最高等级的下标，如果不大于，则将<code>CurrentLevel</code>设置为下一个等级。</p>
<h3 id="u6D4B_u8BD5_u662F_u5426_u53EF_u4EE5_u5347_u7EA7"><a href="#u6D4B_u8BD5_u662F_u5426_u53EF_u4EE5_u5347_u7EA7" class="headerlink" title="测试是否可以升级"></a>测试是否可以升级</h3><p>保存刚才的脚本文件，返回到PlaceMonster.cs文件，增加下面的方法:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">canUpdateMonster</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (monster != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        MonsterData monsterData = monster.GetComponent&lt;MonsterData&gt;();</span><br><span class="line">        MonsterLevel nextLevel = monsterData.getNextLevel();</span><br><span class="line">        <span class="keyword">if</span> (nextLevel != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先，检查<code>monster</code>变量是否为<code>null</code>，如果为<code>null</code>则肯定不能升级了，如果不为<code>null</code>则获取其<code>MonsterData</code>组件，并检查更高的等级是否存在，如果<code>getNextLevel</code>方法返回的值不是<code>null</code>则说明更高的等级存在（返回<code>true</code>），否则不存在（返回<code>false</code>）。</p>
<h3 id="u4F7F_u53EF_u4EE5_u901A_u8FC7_u91D1_u5E01_u5347_u7EA7"><a href="#u4F7F_u53EF_u4EE5_u901A_u8FC7_u91D1_u5E01_u5347_u7EA7" class="headerlink" title="使可以通过金币升级"></a>使可以通过金币升级</h3><p>为了能够升级，在<code>PlaceMonster</code>中的<code>OnMouseUp</code>中添加<code>else if</code>分支:<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnMouseUp</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (canPlaceMonster())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//...这里跟原来的代码一样，这里省略了</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (canUpdateMonster())</span><br><span class="line">    &#123;</span><br><span class="line">        monster.GetComponent&lt;MonsterData&gt;().increaseLevel();</span><br><span class="line">        AudioSource audioSource = gameObject.GetComponent&lt;AudioSource&gt;();</span><br><span class="line">        audioSource.PlayOneShot(audioSource.clip);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先我们通过<code>canUpdateMonster</code>检查能否升级，如果可以升级，则通过调用<code>MonsterData</code>组件的<code>increaseLevel</code>方法升级怪物，最后播放一次声音特效。</p>
<p>保存文件并返回到Unity，运行游戏，试试放置和升级怪物~<br><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/Upgrade-monsters.png" alt="img"></p>
<h3 id="u652F_u4ED8_u91D1_u5E01_-_Game_Manager"><a href="#u652F_u4ED8_u91D1_u5E01_-_Game_Manager" class="headerlink" title="支付金币 - Game Manager"></a>支付金币 - Game Manager</h3><p>目前而言，可以立即的建造和升级任意数目的怪兽，但这样一来，就木有挑战了。</p>
<p>我们接下来就处理金币的问题，为例维护金币的信息，你不得不要在不同的游戏对象之间共享数据信息。<br>下面的图片显示了所有需要金币信息的游戏对象：<br><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2015/06/sharedData.png" alt="img"></p>
<p>我们将使用一个其他对象都能访问的共享对象来存储这类数据。</p>
<p>在Hierarchy面板中，右键选择<code>Create Empty</code>，并命名为<code>GameManager</code>。<br>添加一个C#脚本组件<code>GameManagerBehavior</code>到刚刚创建的<code>GameManager</code>上，然后打开并编辑这个脚本。<br>因为我们需要使用一个<code>label</code>显示玩家所拥有的金币数，所以在文件的顶部增加下面的引用:<br><figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br></pre></td></tr></table></figure></p>
<p>这将允许我们使用UI相关的类型，比如<code>Text</code>用做显示用的label，接下来在类中添加下面的变量：<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">Text</span> goldLabel;</span><br></pre></td></tr></table></figure></p>
<p>这个变量存储了对<code>Text</code>组件的引用，将用于显示玩家所拥有的所有金币数。</p>
<p>现在<code>GameManager</code>已经可以操作label了，但是我们如何保证变量中存储的金币数和label显示的数量同步呢，我们创建一个属性：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> gold;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> Gold</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123; <span class="keyword">return</span> gold; &#125;</span><br><span class="line">    <span class="keyword">set</span></span><br><span class="line">    &#123;</span><br><span class="line">        gold = <span class="keyword">value</span>;</span><br><span class="line">        goldLabel.GetComponent&lt;Text&gt;().text = <span class="string">"GOLD: "</span> + gold;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>是不是看起来很熟悉，这个跟我们在<code>Monster</code>中定义的<code>CurrentLevel</code>比较相像，首先我们创建一个私有的变量<code>gold</code>用来存储当前所有的金币数，然后定义一个名为<code>Gold</code>的属性，并提供getter和setter方法。</p>
<p>在getter方法中简单的直接返回<code>gold</code>，setter方法则比较有趣了，除了设置<code>gold</code>的值，还设置了<code>goldLabel</code>的显示。<br>这样就保持了金币数和显示的同步。</p>
<p>在<code>Start()</code>中增加下面的初始化语句，默认给玩家100金币(当然你可以给更少的)<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Gold = <span class="number">100</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="u7ED9_u811A_u672C_u4E2D_u7684Label_u5BF9_u8C61_u8D4B_u503C"><a href="#u7ED9_u811A_u672C_u4E2D_u7684Label_u5BF9_u8C61_u8D4B_u503C" class="headerlink" title="给脚本中的Label对象赋值"></a>给脚本中的Label对象赋值</h3><p>保持脚本文件并返回到Unity中。</p>
<p>在Hierarcy中，选中GameManager，在Inspector面板，点击<code>GoldLabel</code>右边的圆圈按钮，在Select Text对话框中，选中Scene标签页，并选中<code>GoldLabel</code><br><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/Assign-goldLabel.png" alt="img"></p>
<p>运行游戏，可以看到金币的显示如下:<br><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/1000-gold.png" alt="img"></p>
<h3 id="u68C0_u67E5_u73A9_u5BB6_u7684_u201C_u94B1_u5305_u201D"><a href="#u68C0_u67E5_u73A9_u5BB6_u7684_u201C_u94B1_u5305_u201D" class="headerlink" title="检查玩家的“钱包”"></a>检查玩家的“钱包”</h3><p>打开PlaceMonster.cs文件，增加下面这行代码:<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> GameManagerBehavior gameManager;</span><br></pre></td></tr></table></figure></p>
<p>我们将通过变量<code>gameManager</code>来访问场景中GameManager的<code>GameManagerBehavior</code>组件，并在<code>Start</code>方法中初始化:<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span> <span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    gameManager = GameObject.Find(<span class="string">"GameManager"</span>).GetComponent&lt;GameManagerBehavior&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们使用<code>GameObject.Find</code>方法，找到名为GameManager的游戏对象，然后定位到其<code>GameManagerBehavior</code>组件并存到一个私有变量中，供稍后使用。</p>
<h3 id="u6536_u94B1_uFF01"><a href="#u6536_u94B1_uFF01" class="headerlink" title="收钱！"></a>收钱！</h3><p>我们还没有减少金币数，所以在<code>OnMouseUp</code>方法里面，将原来的TODO注释修改为下面的代码:<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">todo:</span> Deduct gold</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gameManager.Gold -= monster.GetComponent<span class="tag">&lt;<span class="title">MonsterData</span>&gt;</span>().CurrentLevel.cost;</span><br></pre></td></tr></table></figure>
<p>注意是两个地方，在放置和升级的逻辑里各有一处。</p>
<p>保存文件并返回unity，升级一些怪物并注意观察金币数目的变化。现在我们能够减少金币数了，但是。。。玩家可以一直放置怪物（只要有空位），金币数甚至可以变成负数。<br><img src="http://cdn3.raywenderlich.com/wp-content/uploads/2015/06/Bildschirmfoto-2015-06-06-um-16.45.32.png" alt="img"></p>
<p>这显然是不能被允许的，只有当玩家有足够的金币时，才能放置或者升级我们的怪物。</p>
<p>###<br>切换到PlaceMonster.cs脚本，更新<code>canPlaceMonster</code>和<code>canUpdateMonster</code>方法如下，就是加上检查剩余金币是否足够的条件。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">canPlaceMonster</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> cost = monsterPrefab.GetComponent&lt;MonsterData&gt;().levels[<span class="number">0</span>].cost;</span><br><span class="line">    <span class="keyword">return</span> monster == <span class="keyword">null</span> &amp;&amp; gameManager.Gold &gt;= cost; <span class="comment">//确保金币足够</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">bool</span> <span class="title">canUpdateMonster</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (monster != <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        MonsterData monsterData = monster.GetComponent&lt;MonsterData&gt;();</span><br><span class="line">        MonsterLevel nextLevel = monsterData.getNextLevel();</span><br><span class="line">        <span class="keyword">if</span> (nextLevel != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> gameManager.Gold &gt;= nextLevel.cost; <span class="comment">//确保金币足够</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>保存，并运行游戏，试试还能不能无限添加怪物。<br><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2015/06/Monsters-cost-gold.png" alt="img"></p>
<h3 id="u654C_u4EBA_u3001_u6CE2_u6570_u548C_u8DEF_u6807"><a href="#u654C_u4EBA_u3001_u6CE2_u6570_u548C_u8DEF_u6807" class="headerlink" title="敌人、波数和路标"></a>敌人、波数和路标</h3><p>是时候给敌人“铺路”了。敌人首先在第一个路标的地方出现，然后向下一个路标移动并重复这个动作，知道他们抵达你的饼干。<br>我们将通过下面的手段使敌人行军起来：</p>
<ol>
<li>定义敌人移动的路线</li>
<li>使敌人沿着路线移动</li>
<li>旋转敌人，使他们看起来是向前方行进</li>
</ol>
<h3 id="u901A_u8FC7_u8DEF_u6807_u5EFA_u7ACB_u8DEF_u7EBF"><a href="#u901A_u8FC7_u8DEF_u6807_u5EFA_u7ACB_u8DEF_u7EBF" class="headerlink" title="通过路标建立路线"></a>通过路标建立路线</h3><p>在Hierarcy中右键，选择Create Empty创建一个新的空的游戏对象，命名为Road，并确保其位置坐标为(0, 0, 0)<br>接下来，右键点击Road并创建另一个空的游戏对象，命名为Waypoint0 并将其坐标设置为（-12， 2， 0），这将是敌人开始进攻的起始点。<br><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/Road-waypoint-hierarchy.png" alt="img"></p>
<p>创建另外5个路标：</p>
<ul>
<li>Waypoint1: (7, 2, 0)</li>
<li>Waypoint2: (7, -1, 0)</li>
<li>Waypoint3: (-7, 3, 0)</li>
<li>Waypoint4: (-7.3, -4.5, 0)</li>
<li>Waypoint5: (7, -4.5, 0)<br>下面的截图标示出了路标的位置以及最终的路线：<br><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2015/07/Screen-Shot-2015-07-24-at-12.09.11-PM1.png" alt="img"></li>
</ul>
<h3 id="u53EC_u5524_u654C_u4EBA"><a href="#u53EC_u5524_u654C_u4EBA" class="headerlink" title="召唤敌人"></a>召唤敌人</h3><p>现在是时候去创建一些敌人来沿着上面的路线移动了。在Prefabs的文件夹中包含了一个Enemy的prefab。 它的位置坐标是（-20,0,0） ，所以新创建的敌人对象一开始在平面外面。</p>
<p>跟Monster的prefab一样，Enemy的prefab同样包含了一个AudioSource，一个精灵图片（一会儿可以旋转其方向）。<br><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2015/06/Bug1-1.png" alt="img"></p>
<h3 id="u4F7F_u654C_u4EBA_u6CBF_u7740_u8DEF_u7EBF_u79FB_u52A8"><a href="#u4F7F_u654C_u4EBA_u6CBF_u7740_u8DEF_u7EBF_u79FB_u52A8" class="headerlink" title="使敌人沿着路线移动"></a>使敌人沿着路线移动</h3><p>向Prefabs\Enemy新建一个名为MoveEnemy的C#脚本，使用代码编辑器打开，并添加下面的变量定义:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[HideInInspector]</span><br><span class="line"><span class="keyword">public</span> GameObject[] waypoints;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> currentWaypoint = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">float</span> lastWaypointSwitchTime;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">float</span> speed = <span class="number">1.0f</span>;</span><br></pre></td></tr></table></figure></p>
<p><code>waypoints</code>以数组的形式存储了所有的路标，它上面的<code>HideInInspector</code>特性确保了我们不会在inspector面板中不小心修改了它的值，但是我们仍然可以在其他脚本中访问。<br><code>currentWaypoint</code>记录了敌人当前所在的路标，<code>lastWaypointSwitchTime</code>记录了当敌人经过路标时用的时间，最后使用<code>speed</code>存储敌人的移动速度。</p>
<p>增加下面这行代码到<code>Start</code>方法中：<br><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lastWaypointSwitchTime = <span class="built_in">Time</span>.<span class="built_in">time</span>;</span><br></pre></td></tr></table></figure></p>
<p>这里将<code>lastWaypointSwitchTime</code>初始化为当前时间。</p>
<p>为了使敌人能沿路线移动，在<code>Update</code>方法中添加下面的代码:<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1 </span></span><br><span class="line">Vector3 startPosition = <span class="built_in">waypoints</span>[<span class="built_in">currentWaypoint</span>].transform.<span class="built_in">position</span>;</span><br><span class="line">Vector3 endPosition = <span class="built_in">waypoints</span>[<span class="built_in">currentWaypoint</span> + <span class="number">1</span>].transform.<span class="built_in">position</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2 </span></span><br><span class="line">float pathLength = Vector3.<span class="built_in">Distance</span>(startPosition, endPosition);</span><br><span class="line">float totalTimeForPath = pathLength / <span class="built_in">speed</span>;</span><br><span class="line">float currentTimeOnPath = <span class="built_in">Time</span>.<span class="built_in">time</span> - lastWaypointSwitchTime;</span><br><span class="line">gameObject.transform.<span class="built_in">position</span> = Vector3.Lerp(startPosition, endPosition, currentTimeOnPath / totalTimeForPath);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3 </span></span><br><span class="line"><span class="keyword">if</span> (gameObject.transform.<span class="built_in">position</span>.Equals(endPosition))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">currentWaypoint</span> &lt; <span class="built_in">waypoints</span>.Length - <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3.a </span></span><br><span class="line">        <span class="built_in">currentWaypoint</span>++;</span><br><span class="line">        lastWaypointSwitchTime = <span class="built_in">Time</span>.<span class="built_in">time</span>;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Rotate into move direction</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 3.b </span></span><br><span class="line">        Destroy(gameObject);</span><br><span class="line"></span><br><span class="line">        AudioSource audioSource = gameObject.GetComponent&lt;AudioSource&gt;();</span><br><span class="line">        AudioSource.PlayClipAtPoint(audioSource.clip, transform.<span class="built_in">position</span>);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> deduct health</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>让我们一步一步来看:</p>
<ol>
<li>从路标数组中，取出当前路段的开始路标和结束路标。</li>
<li>计算出通过整个路段所需要的时间（使用 距离除以速度 的公式），使用<code>Vector3.Lerp</code>插值计算出当前时刻应该在的位置。</li>
<li>检查敌人是否已经抵达结束路标，如果是，则有两种可能的场景:<br> A. 敌人尚未抵达最终的路标，所以增加<code>currentWayPoint</code>并更新<code>lastWaypointSwitchTime</code>，稍后我们要增加旋转敌人的代码使他们朝向前进的方向。<br> B. 敌人抵达了最终的路标，就销毁敌人对象，并触发声音特效，稍后我们要增加减少玩家生命值的代码。</li>
</ol>
<p>保存文件，并返回到Unity。</p>
<h3 id="u7ED9_u654C_u4EBA_u6307_u660E_u65B9_u5411"><a href="#u7ED9_u654C_u4EBA_u6307_u660E_u65B9_u5411" class="headerlink" title="给敌人指明方向"></a>给敌人指明方向</h3><p>现在，敌人还不知道路标的次序。</p>
<p>在Hierarchy中选中Road，然后添加一个新的C#脚本命名为SpawnEnemy，并在代码编辑器中打开，增加下面的变量:<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public GameObject<span class="string">[]</span> waypoints;</span><br></pre></td></tr></table></figure></p>
<p>我们将使用<code>waypoints</code>来存放路标的引用。<br>保存文件返回Unity， 在Hierarchy中选中Road，将<code>WayPoints</code>数组的大小改为6，拖拽Road的孩子节点到想用的Element位置，Waypoint0对应Element0以此类推。<br><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2015/07/waypoints2.gif" alt="gif"></p>
<p>现在我们已经有了路线的路标数组，注意到敌人不会退缩。。。<br><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2012/07/certaindeath.jpg" alt="img"></p>
<h3 id="u68C0_u67E5_u4E00_u5207_u987A_u5229"><a href="#u68C0_u67E5_u4E00_u5207_u987A_u5229" class="headerlink" title="检查一切顺利"></a>检查一切顺利</h3><p>打开SpawnEnemy脚本，增加下面的变量：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> GameObject testEnemyPrefab;</span><br></pre></td></tr></table></figure></p>
<p>这里使用了<code>testEnemyPrefab</code>保存对<code>Enemy</code>prefab的引用。<br>使用下面的代码，当脚本开始时添加一个敌人：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Start</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Instantiate(testEnemyPrefab).GetComponent&lt;MoveEnemy&gt;().waypoints = waypoints;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的代码使用testEnemyPrefab实例化一个敌人对象，并将路标赋值给它。</p>
<p>保存文件返回Unity，在Hierarchy中选中Road并将Enemy prefab赋值给testEnemyPrefab。<br> 运行游戏，可以看到敌人已经能够沿着路线移动了:<br><img src="http://cdn1.raywenderlich.com/wp-content/uploads/2015/06/BugFollowsRoadWithoutRotating.gif" alt="gif"></p>
<p>nice,但是有没有注意到敌人移动的时候没有朝向移动的方向。。没有关系，这个问题将在part2部分修复。</p>
<blockquote>
<p>原文地址：<a href="http://www.raywenderlich.com/107525/create-tower-defense-game-unity-part-1" target="_blank" rel="external">http://www.raywenderlich.com/107525/create-tower-defense-game-unity-part-1</a></p>
</blockquote>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/01/27/template-strings/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          ES6 template string模板字符串
        
      </div>
    </a>
  
  
    <a href="/2016/01/20/tip-to-measure-performance-of-a-js-block/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">测量js代码块性能的小技巧</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="create-tower-defense-game-unity-part-1" data-title="使用unity创建塔防游戏(译)(part1)" data-url="http://le0zh.github.io/2016/01/21/create-tower-defense-game-unity-part-1/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"le0zh"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 le0zh
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>